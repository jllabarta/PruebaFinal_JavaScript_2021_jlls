<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <!--The viewport meta tag is used to improve the presentation and behavior of the samples
      on iOS devices-->
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
    <title>PruebaFinal_API_JS_JLLS</title>

    <link rel="stylesheet" href="http://js.arcgis.com/3.8/js/dojo/dijit/themes/claro/claro.css">
    <link rel="stylesheet" href="https://js.arcgis.com/3.27/esri/css/esri.css">
    <link rel="stylesheet" href="css/layout.css"/>

    <script>var dojoConfig = { parseOnLoad: true };</script>
    <script src="https://js.arcgis.com/3.27/"></script>

    <style>
      #divSearch {
        display: block;
        position: absolute;
        z-index: 2;
        top: 10px;
        left: 70px;}
      #basemapGallery {
        position: absolute;
        top: 20px;
        right: 20px;
        z-index: 50;}
      #MapaPeque {
        position: absolute;
        bottom: 120px;
        left: 30px;
        z-index: 50;
        border-color: black;
        border-style: solid;
        border:thick}
    </style>
    <script>

    var mapMain;
    var tb;
    
    require(["esri/map",
        "esri/layers/ArcGISDynamicMapServiceLayer",
        "esri/layers/FeatureLayer",
        "esri/geometry/Extent",
        "esri/toolbars/draw",
        "esri/graphic",
        "esri/tasks/query",

        "esri/dijit/Scalebar",
        "esri/dijit/Legend",
        "esri/dijit/BasemapGallery",
        "esri/dijit/Search",
        "esri/dijit/OverviewMap",
        "esri/dijit/PopupTemplate",

        "esri/symbols/SimpleFillSymbol",
        "esri/symbols/SimpleLineSymbol",
        "esri/symbols/SimpleMarkerSymbol",
        
        "dojo/ready",
        "dojo/parser",
        "dojo/on",
        "dojo/dom",

        "dojo/store/Memory",
        "dojo/date/locale",

        "dojo/_base/Color",
        "dojo/_base/declare",
        "dojo/_base/array",

        "dgrid/OnDemandGrid",
        "dgrid/Selection",

        "dijit/layout/TabContainer",
        "dijit/layout/ContentPane",
        "dijit/layout/BorderContainer",
        "dojo/domReady!"],
        function(Map, ArcGISDynamicMapServiceLayer, FeatureLayer, Extent, Draw, Graphic, Query,      
        Scalebar, Legend, BasemapGallery, Search, OverviewMap, PopupTemplate,
        SimpleFillSymbol, SimpleLineSymbol, SimpleMarkerSymbol,        
        ready, parser, on, dom, 
        Memory, locale,
        Color, declare, array,
        Grid, Selection,
        BorderContainer, ContentPane, Button
        ) {

        var gridCities = new (declare([Grid, Selection]))({
                bufferRows: Infinity,
                columns: {
                  st: "Estado",
                  areaname: "Ciudad",
                  pop2000: "Población"
                }
        }, "divGrid");

        on(dojo.byId("pintaYQuery"),"click",fPintaYQuery);
        on(dojo.byId("progButtonNode"),"click",fQueryEstados);

        function fPintaYQuery(){
          var tbDraw = new Draw(mapMain);
          tbDraw.on("draw-complete",addToMap);
          tbDraw.activate(Draw.POLYGON);
        }
        function addToMap(evt) {
          var geometryInput = evt.geometry;
          var tbDrawSymbol = new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID, new SimpleLineSymbol(SimpleLineSymbol.STYLE_DASHDOT, new Color([255, 255, 0]), 2), new Color([255, 255, 0, 0.2]));
          mapMain.graphics.clear();
          var graphicPolygon = new Graphic(geometryInput, tbDrawSymbol);
          mapMain.graphics.add(graphicPolygon);
          selectCities(geometryInput);
        }      
        function selectCities(geometryInput) {
          var symbolSelected = new SimpleMarkerSymbol({
            "type": "esriSMS",
            "style": "esriSMSCircle",
            "color": [255, 0, 0, 128],
            "size": 8,
            "outline": {"color": [255, 225, 0, 214],
                    "width": 1}
          });
          lyrCities.setSelectionSymbol(symbolSelected);

          var queryCities = new Query();
          queryCities.geometry = geometryInput;
          lyrCities.on("selection-complete",populateGrid);
          lyrCities.selectFeatures(queryCities,FeatureLayer.SELECTION_NEW);
        }        
        function populateGrid(results) {               
          var gridData;
          dataCities = array.map(results.features, function (feature) {
             return {"st": feature.attributes[outFieldsCities[0]],
                      "areaname": feature.attributes[outFieldsCities[1]],
                      "pop2000": feature.attributes[outFieldsCities[2]],
                    }
           });
          var memStore = new Memory({
            data: dataCities
          });
          gridCities.set("store", memStore);
          
        }



        function fQueryEstados(){
         alert("Evento del botón Seleccionar ciudades");
        }      
   


        
        var extentInitial = new Extent({
        "xmin": -11535191.501121324,
        "ymin": 3286084.8695277404,
        "xmax": -7350110.356180864,
        "ymax": 6548702.8609162215,
        "spatialReference": { "wkid": 102100 }
      });
        
      mapMain = new Map("map", {
        basemap: "topo",
        extent: extentInitial
      });

      var template=new PopupTemplate({
          title: "Información sobre la ciudad "+"{areaname}"+", "+"{st}",
          description: "{areaname}"+", "+"{st}"+ ": con una población de "+"{pop2000}"+ " personas."
        });

      var lyrUSA = new ArcGISDynamicMapServiceLayer("http://sampleserver6.arcgisonline.com/arcgis/rest/services/USA/MapServer", {opacity: 0.25});
        lyrUSA.setVisibleLayers([1, 2, 3]);
      var outFieldsCities = ["st", "areaname", "pop2000"];
      var lyrCities = new FeatureLayer("http://sampleserver6.arcgisonline.com/arcgis/rest/services/USA/MapServer/0",{
        outFields: outFieldsCities,
        infoTemplate: template
      });
    
      mapMain.on("load", function (evt) {
        mapMain.resize();
        mapMain.reposition();
        mapMain.addLayer(lyrUSA);
        mapMain.addLayer(lyrCities);
      });
      var dijiScalebar = new Scalebar({
        map: mapMain,
        scalebarUnit: "dual",
        attachTo: "bottom-center"
      });
      var Leyenda = new Legend({
        map: mapMain,
        arrangement: Legend.ALIGN_LEFT
      }, "legendDiv");
      Leyenda.startup();

      var basemapGallery = new BasemapGallery({
        showArcGISBasemaps: true,
        map: mapMain
      }, "basemapGallery");
      basemapGallery.startup();

      var dijitSearch = new Search({
                map: mapMain,
                autoComplete: true,
                height: 10,
                width: 120,
            }, "divSearch");
      dijitSearch.startup();
      
      var overviewMapDijit = new OverviewMap({
        map: mapMain,
        attachTo: "bottom-right",
        environment: {
          background: {
            type: "color",
            color: [255, 255, 255, 0]
          },
          starsEnabled: false,
          atmosphereEnabled: false
        },
        height: 100,
        width: 120,

        },"MapaPeque");
        overviewMapDijit.startup();

      });



    </script>

  </head>

  <body class="claro">
    <div id="mainWindow"
         data-dojo-type="dijit.layout.BorderContainer"
         data-dojo-props="design:'headline', gutters:false"
         style="width:100%; height:100%;">

      <div id="header"
           data-dojo-type="dijit.layout.ContentPane" data-dojo-props="region:'top'">

        Master GIS ESRI España
       <div id="subheader">J.L. LABARTA SAUCO</div>

      </div>
      <div data-dojo-type="dijit.layout.ContentPane" id="leftPane" data-dojo-props="region:'left'">
        <div data-dojo-type="dijit.layout.TabContainer">

          <div data-dojo-type="dijit.layout.ContentPane" data-dojo-props="title:'Leyenda', selected:true">
            <div id="legendDiv"></div>
          </div>

          <div data-dojo-type="dijit.layout.ContentPane" data-dojo-props="title:'Tareas'" >
            Operaciones
            <button id="pintaYQuery" type="button">Seleccionar ciudades</button> <button id="OffpintaYQuery" type="button">Quitar selección</button>
            <div id="divGrid"></div>
          </div>

        </div>
      </div>

      <div id="map" data-dojo-type="dijit.layout.ContentPane" data-dojo-props="region:'center'">
        <div id="divSearch"></div>
        <div id="MapaPeque"></div>
        <div style="position:absolute; right:20px; top:10px; z-Index:999;">
          <div data-dojo-type="dijit/TitlePane"
               data-dojo-props="title:'Switch Basemap', closable:false, open:false">
              <div data-dojo-type="dijit/layout/ContentPane" style="width:380px; height:280px; overflow:auto;">
                  <div id="basemapGallery"></div>                  
              </div>            
          </div>
        
        </div>

      </div>

      <div id="footer" data-dojo-type="dijit.layout.ContentPane" data-dojo-props="region:'bottom'">

        <label for="dtb">Introduzca el nombre de un estado:</label> <input id="dtb" data-dojo-type="dijit/form/TextBox" value="Washington" />
        <button id="progButtonNode" type="button">Ir al estado</button>
      </div>

    </div>
  </body>

</html>
